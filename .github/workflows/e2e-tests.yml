name: E2E Tests

on:
  deployment_status:

jobs:
  check-pr-status:
    name: Check if PR is open
    runs-on: ubuntu-latest
    if: github.event.deployment_status.state == 'success'
    outputs:
      pr-open: ${{ steps.pr-check.outputs.pr-open }}
      pr-number: ${{ steps.pr-check.outputs.pr-number }}
    steps:
      - name: Check PR status
        id: pr-check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.payload.deployment.sha
              });
              
              if (prs.length === 0) {
                console.log('No PR found for this deployment');
                core.setOutput('pr-open', 'false');
                core.setOutput('pr-number', '');
                return;
              }
              
              const pr = prs[0];
              const isOpen = pr.state === 'open';
              const isPromotionPR = pr.base && (pr.base.ref === 'qa' || pr.base.ref === 'prod' || pr.base.ref === 'main');
              
              console.log(`Found PR #${pr.number}, state: ${pr.state}, base: ${pr.base?.ref || 'unknown'}`);
              
              if (isPromotionPR) {
                console.log(`This is a promotion PR to ${pr.base.ref} - running tests regardless of PR state`);
                core.setOutput('pr-open', 'true');
                core.setOutput('pr-number', pr.number.toString());
              } else if (isOpen) {
                console.log(`PR is open - running tests`);
                core.setOutput('pr-open', 'true');
                core.setOutput('pr-number', pr.number.toString());
              } else {
                console.log(`Skipping tests - PR #${pr.number} is ${pr.state} and not a promotion PR`);
                core.setOutput('pr-open', 'false');
                core.setOutput('pr-number', pr.number.toString());
              }
            } catch (error) {
              console.error('Error checking PR status:', error);
              core.setOutput('pr-open', 'false');
              core.setOutput('pr-number', '');
            }

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: check-pr-status
    if: needs.check-pr-status.outputs.pr-open == 'true'
    permissions:
      actions: read
      contents: read
      pull-requests: write
    steps:
      - name: Debug deployment info
        run: |
          echo "Deployment environment: ${{ github.event.deployment_status.environment }}"
          echo "Deployment state: ${{ github.event.deployment_status.state }}"
          echo "Deployment URL: ${{ github.event.deployment_status.target_url }}"
          echo "Event name: ${{ github.event_name }}"

      - name: Set deployment URL
        id: deployment
        run: |
          DEPLOYMENT_URL="${{ github.event.deployment_status.target_url }}"
          echo "Using deployment URL: $DEPLOYMENT_URL"
          echo "BASE_URL=$DEPLOYMENT_URL" >> "$GITHUB_ENV"

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run Playwright Tests
        id: run-tests
        run: npx playwright test --project=chromium
        env:
          BASE_URL: ${{ env.BASE_URL }}
          # Development environment test users
          CLERK_TEST_DEV_ADMIN_EMAIL: ${{ secrets.CLERK_TEST_DEV_ADMIN_EMAIL }}
          CLERK_TEST_DEV_ADMIN_PASSWORD: ${{ secrets.CLERK_TEST_DEV_ADMIN_PASSWORD }}
          CLERK_TEST_DEV_SALES_EMAIL: ${{ secrets.CLERK_TEST_DEV_SALES_EMAIL }}
          CLERK_TEST_DEV_SALES_PASSWORD: ${{ secrets.CLERK_TEST_DEV_SALES_PASSWORD }}
          CLERK_TEST_DEV_READONLY_EMAIL: ${{ secrets.CLERK_TEST_DEV_READONLY_EMAIL }}
          CLERK_TEST_DEV_READONLY_PASSWORD: ${{ secrets.CLERK_TEST_DEV_READONLY_PASSWORD }}
          # QA environment test users
          CLERK_TEST_QA_ADMIN_EMAIL: ${{ secrets.CLERK_TEST_QA_ADMIN_EMAIL }}
          CLERK_TEST_QA_ADMIN_PASSWORD: ${{ secrets.CLERK_TEST_QA_ADMIN_PASSWORD }}
          CLERK_TEST_QA_SALES_EMAIL: ${{ secrets.CLERK_TEST_QA_SALES_EMAIL }}
          CLERK_TEST_QA_SALES_PASSWORD: ${{ secrets.CLERK_TEST_QA_SALES_PASSWORD }}
          CLERK_TEST_QA_READONLY_EMAIL: ${{ secrets.CLERK_TEST_QA_READONLY_EMAIL }}
          CLERK_TEST_QA_READONLY_PASSWORD: ${{ secrets.CLERK_TEST_QA_READONLY_PASSWORD }}
          # Production environment test users
          CLERK_TEST_PROD_ADMIN_EMAIL: ${{ secrets.CLERK_TEST_PROD_ADMIN_EMAIL }}
          CLERK_TEST_PROD_ADMIN_PASSWORD: ${{ secrets.CLERK_TEST_PROD_ADMIN_PASSWORD }}
          CLERK_TEST_PROD_SALES_EMAIL: ${{ secrets.CLERK_TEST_PROD_SALES_EMAIL }}
          CLERK_TEST_PROD_SALES_PASSWORD: ${{ secrets.CLERK_TEST_PROD_SALES_PASSWORD }}
          CLERK_TEST_PROD_READONLY_EMAIL: ${{ secrets.CLERK_TEST_PROD_READONLY_EMAIL }}
          CLERK_TEST_PROD_READONLY_PASSWORD: ${{ secrets.CLERK_TEST_PROD_READONLY_PASSWORD }}
          # Multi-org test user
          CLERK_TEST_MULTI_ORG_EMAIL: ${{ secrets.CLERK_TEST_MULTI_ORG_EMAIL }}
          CLERK_TEST_MULTI_ORG_PASSWORD: ${{ secrets.CLERK_TEST_MULTI_ORG_PASSWORD }}

      - name: Upload test reports
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            playwright-report
            test-results
          retention-days: 30

      - name: Parse test results
        if: always()
        id: test-results
        shell: bash
        run: |
          if [ -f "test-results/.last-run.json" ]; then
            echo "Found .last-run.json, parsing test results..."
            
            STATUS=$(cat test-results/.last-run.json | jq -r '.status' 2>/dev/null || echo "unknown")
            
            if [ "$STATUS" = "passed" ]; then
              echo "status=passed" >> $GITHUB_OUTPUT
              echo "failed_count=0" >> $GITHUB_OUTPUT
            else
              echo "status=failed" >> $GITHUB_OUTPUT
              # Count failed tests from test-results directories
              FAILED_COUNT=$(find test-results -maxdepth 1 -type d -name "*-chromium*" | wc -l | tr -d ' ')
              echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT
            fi
          elif [ -d "playwright-report" ]; then
            echo "Using playwright report directory presence as indicator"
            if [ "${{ steps.run-tests.outcome }}" = "success" ]; then
              echo "status=passed" >> $GITHUB_OUTPUT
              echo "failed_count=0" >> $GITHUB_OUTPUT
            else
              echo "status=failed" >> $GITHUB_OUTPUT
              echo "failed_count=unknown" >> $GITHUB_OUTPUT
            fi
          else
            echo "⚠️  Test results not found"
            echo "status=unknown" >> $GITHUB_OUTPUT
            echo "failed_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR with test results
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const testOutcome = '${{ steps.run-tests.outcome }}';
            const testStatus = testOutcome === 'success' ? '✅' : '❌';
            const deploymentUrl = '${{ github.event.deployment_status.target_url }}';

            const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.payload.deployment.sha
            });

            if (prs.length === 0) {
              console.log('No PR found for this deployment, skipping comment');
              return;
            }

            const prNumber = prs[0].number;
            console.log(`Found PR #${prNumber} for deployment`);

            let body = `## ${testStatus} E2E Test Results\n\n`;
            body += `**Preview Deployment:** ${deploymentUrl}\n\n`;
            body += `**Status:** ${testOutcome === 'success' ? 'All tests passed' : 'Some tests failed'}\n\n`;
            body += `[View full test report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Notify Slack on Test Success
        if: steps.run-tests.outcome == 'success'
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: '✅ E2E Tests Passed',
              attachments: [{
                color: 'good',
                text: `${{ github.repository }} - ${{ github.ref_name }} by ${{ github.actor }}\nURL: ${{ env.BASE_URL }}\n\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run>`
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on Test Failure
        if: (steps.run-tests.outcome == 'failure' || failure())
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "❌ E2E Tests Failed",
              "attachments": [{
                "color": "danger",
                "text": "${{ github.repository }} - ${{ github.ref_name }} by ${{ github.actor }}\nURL: ${{ env.BASE_URL }}\n\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run>"
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
